#!/usr/bin/env just

# --- Settings --- #
set shell                       := ["nu", "-c"]
set positional-arguments        := true
set allow-duplicate-variables   := true
set windows-shell               := ["nu", "-c"]
set dotenv-load                 := true

# --- Variables --- #
project_root        := justfile_directory()
output_directory    := project_root + "/dist"

system              := `uname | get machine` + "-apple-" + os()			# Swift target triple (â€œarm64-apple-macosxâ€, etc.)
main_package        := "${MAIN_BINARY}"						# The main artifact
build_dir           := project_root + "/.build"				# Build output root
debug_bin           := build_dir + "/" + system + "/debug/" + main_package
release_bin         := build_dir + "/" + system + "/release/" + main_package

# â–°â–°â–°â–°â–°â–°â–°â–°â–°â–°â–°â–°â–°â–°â–°â–°â–° #
#      Recipes      #
# â–°â–°â–°â–°â–°â–°â–°â–°â–°â–°â–°â–°â–°â–°â–°â–°â–° #

[doc('List all available recipes')]
default:
	@just --list

# --- Build & Check --- #
[doc('Build Swift package in debug mode')]
[group('build')]
build target=(system):
	@echo "ğŸ”¨ Building Swift package (debug)â€¦"
	swift build --triple '{{target}}'

[doc('Build Swift package in release mode')]
[group('build')]
build-release target=(system):
	@echo "ğŸš€ Building Swift package (release)â€¦"
	swift build -c release --triple '{{target}}' \
		-Xswiftc "-whole-module-optimization" \
		-Xlinker "-dead_strip"

# --- Packaging --- #
[doc('Finalize release binary')]
[group('packaging')]
package target=(system) result_directory=(output_directory):
	just build-release {{target}}
	@echo "ğŸ“¦ Packaging release binaryâ€¦"
	@mkdir -p {{result_directory}}
	@cp {{release_bin}} "{{result_directory}}/{{main_package}}-{{target}}"
	@echo "âœ… Packaged â†’ {{result_directory}}/{{main_package}}-{{target}}"

[doc('Compress binary files in target directory')]
[group('packaging')]
compress directory=(output_directory):
### IMPORT: scripts/build-error.nu 1 ###
### IMPORT: scripts/compress.nu 1 ###

[doc('Generate SHA256 checksums for distribution')]
[group('packaging')]
checksum directory=(output_directory):
### IMPORT: scripts/build-error.nu 1 ###
### IMPORT: scripts/checksum.nu 1 ###

[doc('Complete release pipeline: build, checksum, and compress')]
[group('packaging')]
release: build-release
	just checksum
	just compress

# --- Execution --- #
[doc('Run application in debug mode')]
[group('execution')]
run +args="":
	@echo "â–¶ï¸ Running {{main_package}} (debug)â€¦"
	swift run '{{main_package}}' -- '$@'

[doc('Run application in release mode')]
[group('execution')]
run-release +args="":
	@echo "â–¶ï¸ Running {{main_package}} (release)â€¦"
	swift run -c release -Xswiftc "-whole-module-optimization" '{{main_package}}' -- '$@'

# --- Testing --- #
[doc('Run all tests')]
[group('testing')]
test:
	@echo "ğŸ§ª Running testsâ€¦"
	swift test

[doc('Run tests with additional arguments')]
[group('testing')]
test-with +args="":
	@echo "ğŸ§ª Running tests with args: '$@'"
	swift test -- '$@'

# --- Code Quality --- #
[doc('Format Swift code')]
[group('quality')]
fmt:
	@echo "ğŸ’… Formatting Swift code..."
	find . -name "*.swift" -type f -exec swift-format format -i {} +

[doc('Check Swift formatting (lint mode)')]
[group('quality')]
fmt-check:
	@echo "ğŸ’… Checking Swift formatting..."
	find . -name "*.swift" -type f -exec swift-format lint {} +

# --- Documentation --- #
[doc('Generate project documentation')]
[group('docs')]
doc:
	@echo "ğŸ“š Generating documentationâ€¦"
	swift package generate-documentation --target '{{main_package}}'

[doc('Generate documentation and open in browser')]
[group('docs')]
doc-open: doc
	@open .build/documentation/{{main_package}}/index.html

# --- Maintenance --- #
[doc('Extract release notes from changelog for specified tag')]
[group('maintenance')]
create-notes raw_tag outfile changelog:
### IMPORT: scripts/build-error.nu 1 ###
### IMPORT: scripts/create-notes.nu 1 ###

[doc('Update Swift package dependencies')]
[group('maintenance')]
update:
	@echo "ğŸ”„ Updating dependencies..."
	swift package update

[doc('Clean build artifacts')]
[group('maintenance')]
clean:
	@echo "ğŸ§¹ Cleaning build artifacts..."
	swift package clean

# --- Installation --- #
[doc('Install release binary into /usr/local/bin')]
[group('installation')]
install package=(main_package): build-release
	@echo "ğŸ’¾ Installing {{package}} â†’ /usr/local/bin..."
	@cp '{{release_bin}}' /usr/local/bin/{{package}}

[doc('Force install binary')]
[group('installation')]
install-force package=(main_package): build-release
	@echo "ğŸ’¾ Force installing {{package}} â†’ /usr/local/bin..."
	@cp '{{release_bin}}' "/usr/local/bin/{{package}}" --force

# --- Aliases --- #
alias b		:= build
alias br	:= build-release
alias p		:= package
alias rel	:= release
alias c		:= checksum
alias cs	:= compress
alias r		:= run
alias rr	:= run-release
alias t		:= test
alias tw	:= test-with
alias f		:= fmt
alias fc	:= fmt-check
alias d		:= doc
alias do	:= doc-open
alias cl	:= clean
alias up	:= update
alias i		:= install
alias ifo	:= install-force
